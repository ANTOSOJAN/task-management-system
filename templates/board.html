<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ board.title }} - Task Board</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav>
        <a href="/">‚Üê Back to All Boards</a>
    </nav>

    <div class="container">
        <header>
            <h1>{{ board.title }}</h1>
            <p>{{ board.description or "No description" }}</p>

            {% if request.query_params.get('error') %}
                <div class="error-box">
                    {% if request.query_params.get('error') == 'board_has_tasks' %}
                        <p class="error-text"> Cannot delete board: tasks still exist.</p>
                    {% elif request.query_params.get('error') == 'board_has_members' %}
                        <p class="error-text"> Cannot delete board: other members are still present.</p>
                    {% elif request.query_params.get('error') == 'not_creator' %}
                        <p class="error-text"> You do not have permission to perform this action.</p>
                    {% else %}
                        <p class="error-text"> Unable to process the request. Please try again.</p>
                    {% endif %}
                </div>
            {% endif %}

            {% if board.is_creator %}
                <p class="creator-badge">You created this board</p>
            {% endif %}
        </header>

        <section>
            <h2>Task Stats</h2>
            <p>Total Tasks: {{ total_tasks }}</p>
            <p>Active Tasks: {{ active_tasks }}</p>
            <p>Completed Tasks: {{ completed_tasks }}</p>
        </section>

        <section>
            <h2>Board Members</h2>
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member in members %}
                    <tr {% if member.email == user_email %}class="highlight"{% endif %}>
                        <td>
                            {{ member.email }}
                            {% if member.userId == board.createdBy %}
                                <span class="creator-badge">Creator</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if member.userId == board.createdBy %}
                                <span class="creator-badge">Creator</span>
                            {% elif member.email == user_email %}
                                <span class="you-badge">You</span>
                            {% else %}
                                Member
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        {% if board.is_creator %}
        <section>
            <h2>Add New Member</h2>
            <form action="/board/{{ board.id }}/add-user" method="post">
                <div class="form-group">
                    <label for="email">User Email:</label>
                    <input type="email" name="email" id="email" required>
                </div>
                <button type="submit">Add Member</button>
            </form>
        </section>

        <section>
            <h2>Remove Board</h2>
            <p><strong>Note:</strong> You can only remove the board if all members (except you) and tasks have been removed.</p>
            <form action="/board/{{ board.id }}/delete" method="post" onsubmit="return confirm('Are you sure you want to delete this board?');">
                <button type="submit">Delete Board</button>
            </form>
        </section>
        {% endif %}

        <section>
            <h2>Tasks</h2>
            {% if user_token %}
            <div class="task-form">
                <h3>Add New Task</h3>
                {% if request.query_params.get('error') == 'task_exists' %}
                <div class="error-box">
                    <p class="error-text"> A task with that title already exists on this board.</p>
                </div>
                {% endif %}
                <form action="/board/{{ board.id }}/add-task" method="post">
                    <div class="form-group">
                        <label for="title">Task Title:</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="due_date">Due Date:</label>
                        <input type="date" id="due_date" name="due_date" required>
                    </div>
                    <div class="form-group">
                        <label for="assignees">Assign To:</label>
                        <div id="assignees">
                            {% for member in members %}
                            <label>
                                <input type="checkbox" name="assignees" value="{{ member.email }}" {% if member.email == user_email %}checked{% endif %}>
                                {{ member.email }}
                            </label><br>
                            {% endfor %}
                        </div>
                    </div>
                    <button type="submit">Create Task</button>
                </form>
            </div>
            {% endif %}

            <div class="task-list">
                {% if tasks|length == 0 %}
                    <p>No tasks yet. Add your first task!</p>
                {% else %}
                    {% for task in tasks %}
                    <div class="task-item {% if task.completed %}completed{% endif %} {% if not task.assignees %}unassigned red-highlight{% endif %}">
                        <h3>{{ task.title }}</h3>
                        <p>Due: {{ task.due_date }}</p>
                        <p>Assigned to: {{ task.assignees|join(', ') or 'Unassigned' }}</p>
                        {% if task.completed and task.completed_at %}
                            <p class="completion-info">Completed on: {{ task.completed_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        {% endif %}
                        <div class="task-actions">
                            <form action="/board/{{ board.id }}/task/{{ task.id }}/toggle" method="post" class="toggle-form">
                                <label>
                                    <input type="checkbox" name="completed" onchange="this.form.submit()" {% if task.completed %}checked{% endif %}>
                                    Mark as {{ 'Incomplete' if task.completed else 'Complete' }}
                                </label>
                            </form>

                            <button onclick="toggleEditForm('edit-form-{{ task.id }}')">Edit</button>

                            <form id="edit-form-{{ task.id }}" action="/board/{{ board.id }}/task/{{ task.id }}/edit" method="post" style="display: none;" class="edit-form">
                                <div class="form-group">
                                    <label>Task Title:</label>
                                    <input type="text" name="title" value="{{ task.title }}" required>
                                </div>
                                <div class="form-group">
                                    <label>Due Date:</label>
                                    <input type="date" name="due_date" value="{{ task.due_date }}" required>
                                </div>
                                <div class="form-group">
                                    <label>Assign To:</label>
                                    {% for member in members %}
                                    <label>
                                        <input type="checkbox" name="assignees" value="{{ member.email }}" {% if member.email in task.assignees %}checked{% endif %}>
                                        {{ member.email }}
                                    </label><br>
                                    {% endfor %}
                                </div>
                                <button type="submit">Save Changes</button>
                                <button type="button" onclick="toggleEditForm('edit-form-{{ task.id }}')">Cancel</button>
                            </form>

                            <form action="/board/{{ board.id }}/task/{{ task.id }}/delete" method="post" onsubmit="return confirm('Are you sure you want to delete this task?');">
                                <button type="submit">Delete</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </section>

        {% if board.is_creator %}
        <section>
            <h2>Board Management</h2>
            <div class="form-group">
                <h3>Rename Board</h3>
                <form action="/board/{{ board.id }}/rename" method="post">
                    <input type="text" name="new_title" value="{{ board.title }}" required>
                    <button type="submit">Update Name</button>
                </form>
            </div>
            <div class="form-group">
                <h3>Remove Member</h3>
                <form action="/board/{{ board.id }}/remove-user" method="post">
                    <div>
                        {% for member in members %}
                            {% if member.email != user_email %}
                                <label>
                                    <input type="checkbox" name="emails" value="{{ member.email }}">
                                    {{ member.email }}
                                </label><br>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <button type="submit">Remove Selected Member</button>
                </form>
            </div>
        </section>
        {% endif %}
    </div>

    <script>
        document.getElementById('sign-out-board')?.addEventListener('click', () => {
            window.location.href = '/logout';
        });

        function toggleEditForm(formId) {
            const form = document.getElementById(formId);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
